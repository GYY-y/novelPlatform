<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="../favioce.png" />
  <title>SKILL 长篇小说</title>
  <style>
    :root {
      --bg: radial-gradient(circle at 20% 20%, #f8f2ff, #d7e8ff 40%, #cde9f2 70%);
      --card: #ffffff;
      --text: #1c2434;
      --muted: #5c6473;
      --accent: #3a7bff;
      --accent-2: #ff8a4d;
      --border: #e5eaf3;
      --shadow: 0 14px 40px rgba(28, 36, 52, 0.15);
      --radius: 18px;
      --font-main: "Inter", "SF Pro Display", "Segoe UI", system-ui, -apple-system, sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 32px;
      min-height: 100vh;
      font-family: var(--font-main);
      color: var(--text);
      background: var(--bg);
    }
    h1 {
      margin: 0 0 12px 0;
      font-size: 28px;
      letter-spacing: 0.4px;
    }
    p.lead {
      margin: 0 0 24px 0;
      color: var(--muted);
    }
    .layout {
      display: grid;
      grid-template-columns: repeat(3, minmax(280px, 1fr));
      gap: 20px;
      align-items: stretch;
    }
    @media (max-width: 1200px) {
      .layout {
        grid-template-columns: repeat(2, minmax(260px, 1fr));
      }
    }
    @media (max-width: 820px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px 20px 16px 20px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, rgba(58, 123, 255, 0.08), rgba(255, 138, 77, 0.06));
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    .card:hover::before { opacity: 1; }
    label {
      display: block;
      font-weight: 600;
      margin: 12px 0 6px;
    }
    select, input[type="text"], textarea {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      color: var(--text);
      background: #f9fbff;
      outline: none;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }
    select:focus, input[type="text"]:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(58, 123, 255, 0.16);
    }
    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
    }
    button {
      border: none;
      border-radius: 14px;
      padding: 12px 16px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #5da3ff);
      color: #fff;
      box-shadow: 0 10px 25px rgba(58, 123, 255, 0.35);
    }
    .btn-secondary {
      background: #f3f6fb;
      color: var(--text);
      border: 1px solid var(--border);
    }
    button:active { transform: translateY(1px); }
    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(58, 123, 255, 0.1);
      color: var(--accent);
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.3px;
    }
    .output {
      width: 100%;
      min-height: 320px;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      background: #0b1020;
      color: #e8ecf7;
      font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Consolas, monospace;
      white-space: pre-wrap;
      overflow: auto;
      flex: 1;
    }
    .input-error {
      border-color: #ff6b6b !important;
      box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.25) !important;
      background: #fff5f5 !important;
    }
    .toolbar {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .status {
      margin-top: 8px;
      color: var(--muted);
      font-size: 13px;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      background: rgba(255, 138, 77, 0.12);
      color: var(--accent-2);
      font-weight: 700;
      font-size: 12px;
    }
    .list-inline {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 0;
      padding: 0;
      list-style: none;
    }
    .list-inline li {
      padding: 6px 10px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 12px;
      color: var(--muted);
    }
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(12, 16, 28, 0.35);
      backdrop-filter: blur(3px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .loading-box {
      background: #ffffff;
      border-radius: 18px;
      padding: 20px 22px;
      box-shadow: var(--shadow);
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 18px;
      border: 1px solid var(--border);
      min-width: 380px;
      max-width: min(92vw, 720px);
    }
    .spinner {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 4px solid #e6edff;
      border-top-color: var(--accent);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-text {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .loading-title {
      font-weight: 700;
      font-size: 16px;
      color: var(--text);
    }
    .loading-sub {
      color: var(--muted);
      font-size: 13px;
    }
    .loading-joke {
      margin-top: 8px;
      padding: 12px 14px;
      background: #f7f9ff;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 13px;
      color: var(--text);
      line-height: 1.5;
      min-height: 120px;
      max-height: 180px;
      overflow: auto;
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loading">
    <div class="loading-box">
      <div class="spinner"></div>
      <div class="loading-text">
        <div class="loading-title">正在生成…</div>
        <div class="loading-sub">预计 3-5 分钟，章节多时更久</div>
        <div class="loading-sub">陪你等：小故事，10 秒一换</div>
        <div class="loading-joke" id="loading-joke">加载中…</div>
        <button class="btn-secondary" id="cancel-btn" style="margin-top:4px;padding:6px 10px;font-size:12px;align-self:flex-start;">取消</button>
      </div>
    </div>
  </div>
  <div class="card" style="margin-bottom:16px;display:grid;grid-template-columns:auto 1fr;gap:16px;align-items:center;">
    <div style="width:72px;height:72px;border-radius:20px;overflow:hidden;box-shadow:var(--shadow);border:1px solid var(--border);background:#fff;display:flex;align-items:center;justify-content:center;">
      <img src="../novelist.png" alt="Logo" style="width:100%;height:100%;object-fit:cover;">
    </div>
    <div>
      <h1 style="margin-bottom:6px;">SKILL 长篇小说</h1>
      <p class="lead" style="margin-bottom:10px;">选择题材、角色与章节设定，一键生成大纲/人物卡/章节预览。卡片式操作，直接预览与下载。</p>
      <ul class="list-inline">
        <li>支持：题材/主角/性格/章节数</li>
        <li>模型：Doubao-Seed-1.8</li>
        <li>API：test.gpulink.top</li>
        <li>输出：Markdown</li>
      </ul>
    </div>
  </div>

  <div class="layout">
    <div class="card form-card">
      <div class="pill">API 配置</div>
      <label for="api-url">API 域名</label>
      <input id="api-url" type="text" placeholder="https://gpulink.cc/v1/chat/completions" value="" />

      <label for="model-id">模型 ID</label>
      <input id="model-id" type="text" placeholder="Doubao-Seed-1.8" value="" />

      <label for="api-key">API Key</label>
      <input id="api-key" type="text" placeholder="sk-..." value="" />

      <hr style="border:none;border-top:1px solid var(--border);margin:18px 0 8px">

      <div class="pill">作品参数</div>
      <label for="novel-name">作品名称</label>
      <input id="novel-name" type="text" placeholder="如：光头勇闯少林" value="光头勇闯少林" />

      <label for="purpose">生成类型</label>
      <select id="purpose">
        <option value="outline">大纲</option>
        <option value="characters">人物档案</option>
        <option value="chapter">章节预览</option>
      </select>

      <label for="genre">题材</label>
      <select id="genre">
        <option>穿越异世界</option>
        <option>奇幻玄幻</option>
        <option>科幻未来</option>
        <option>悬疑推理</option>
        <option>现代言情</option>
        <option>历史架空</option>
        <option>都市现实</option>
      </select>

      <label for="protagonist">主角设定</label>
      <select id="protagonist">
        <option>男性主角</option>
        <option>女性主角</option>
        <option>双主角</option>
        <option>群像</option>
      </select>

      <label for="personality">主角性格</label>
      <select id="personality">
        <option>开朗乐观</option>
        <option>冷静智谋</option>
        <option>温暖治愈</option>
        <option>高冷孤傲</option>
        <option>阴暗腹黑</option>
        <option>成长逆袭</option>
      </select>

      <div class="row">
        <div>
          <label for="chapters">章节数</label>
          <select id="chapters">
            <option>1</option>
            <option>5</option>
            <option>10</option>
            <option>30</option>
            <option>50</option>
            <option>100</option>
            <option>200</option>
            <option>500</option>
            <option>1000</option>
          </select>
        </div>
        <div>
          <label for="tone">基调</label>
          <select id="tone">
            <option>打怪升级</option>
            <option>成长冒险</option>
            <option>黑暗悬疑</option>
            <option>轻松日常</option>
            <option>权谋斗争</option>
          </select>
        </div>
      </div>

      <label for="villains">反派设定（可多名）</label>
      <textarea id="villains" rows="2" placeholder="示例：\n- 名字：卡洛斯；性格：冷静算计；动机：权力与控制\n- 名字：摄政王；性格：野心隐忍；动机：开启通道"></textarea>

      <label for="extra">补充要求（可选）</label>
      <textarea id="extra" rows="3" placeholder="例如：每章 3000-5000 字，开头必须冲突，结尾留钩子。"></textarea>

      <div class="row" style="margin-top:14px">
        <button class="btn-primary" id="generate-btn">一键生成</button>
        <button class="btn-secondary" id="clear-btn">清空输出</button>
      </div>
      <div class="status" id="status">等待生成…</div>
    </div>

    <div class="card output-card">
      <div class="pill">输出预览</div>
      <div class="toolbar">
        <button class="btn-secondary" id="copy-btn">复制</button>
        <button class="btn-secondary" id="download-btn">下载 Markdown</button>
      </div>
      <pre class="output" id="output"></pre>
      <div class="status" id="download-status">准备就绪</div>
    </div>

    <div class="card work-card">
      <div class="pill">作品列表</div>
      <p style="margin:8px 0 12px;color:var(--muted);">快速填充或自定义，支持新增。</p>
      <div class="row">
        <input id="new-work" type="text" placeholder="输入作品名后点击添加" />
        <button class="btn-primary" id="add-work-btn">添加</button>
      </div>
      <div id="work-tags" style="margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;"></div>
    </div>

  </div>

  <script>
    // 元素
    const apiUrlEl = document.getElementById("api-url");
    const apiKeyEl = document.getElementById("api-key");
    const modelIdEl = document.getElementById("model-id");
    const novelNameEl = document.getElementById("novel-name");
    const purposeEl = document.getElementById("purpose");
    const genreEl = document.getElementById("genre");
    const protagonistEl = document.getElementById("protagonist");
    const personalityEl = document.getElementById("personality");
    const chaptersEl = document.getElementById("chapters");
    const toneEl = document.getElementById("tone");
    const villainsEl = document.getElementById("villains");
    const extraEl = document.getElementById("extra");
    const statusEl = document.getElementById("status");
    const outputEl = document.getElementById("output");
    const copyBtn = document.getElementById("copy-btn");
    const downloadBtn = document.getElementById("download-btn");
    const generateBtn = document.getElementById("generate-btn");
    const clearBtn = document.getElementById("clear-btn");
    const workTags = document.getElementById("work-tags");
    const newWorkEl = document.getElementById("new-work");
    const addWorkBtn = document.getElementById("add-work-btn");
    const downloadStatus = document.getElementById("download-status");
    const loadingOverlay = document.getElementById("loading");
    const cancelBtn = document.getElementById("cancel-btn");
    const loadingJokeEl = document.getElementById("loading-joke");

    let workList = ["光头勇闯少林", "星港迷航", "雾城疑案", "青藤日记"];
    let currentAbortController = null;
    let jokeInterval = null;
    let jokeIndex = 0;
    const jokes = [
      `【小故事】塔灵的安全课\n试炼塔入口新贴了一块牌子：“阅读安全提示可提升幸运值 0.0001%。”冒险者们第一次排起长队听塔灵讲课。塔灵一边念稿一边偷偷把幸运值写成 0.00001%，结果第二天排队的人更多了。有人抱怨太慢，塔灵补了一句：“今天听完的，再送一条彩虹屁。”彩虹屁的效果是：被击飞时会带一点残影，毫无作用，却让排队的人更开心。`,
      `【小故事】黑市的“明日更低”\n老纸在摊位挂着牌子：“今日折扣，明日更低。”洛璃问：那我明天来。老纸笑眯眯：“明天的‘低’是指你会掉到我刚挖的陷阱里，视角更低。”第二天真有人踩坑，摔进地下仓库，意外发现隐藏宝箱，打开竟是……一张“今日折扣”券，循环往复。`,
      `【小故事】公会例会的尾款\n卡洛斯主持公会例会：“谁愿意带新人？”盗贼少女举手：“可以，先结算上次带新人的尾款。”全场沉默十秒，卡洛斯咳嗽：“会议到此结束，大家去写周报。”新人在角落悄悄记下：加入公会的第一条生存法则——先问有没有预算。`,
      `【小故事】掉率玄学研究所\n玩家抱怨掉率太低，塔灵决定搞科研：它让玩家填写“开箱前心情表”，结果发现心情和掉率毫无相关。于是塔灵推出新功能：随机给开箱者播放“恭喜发财”的 BGM。效果显著——大家以为要出金，心情变好，依然不出金，但没人投诉了，因为投诉界面被塔灵藏到第 9 层菜单。`,
      `【小故事】迷宫的五星好评\n新手迷宫入口贴着牌子：“前方可能有陷阱。”洛璃认真给了五星好评，还留言：“终于有诚实的副本。”迷宫运营看到后感动地回了一个宝箱奖励。打开后是“诚实徽章”，装备后效果：NPC 更愿意告诉你陷阱在哪，但陷阱的数量不会减少。`,
      `【小故事】实名制2.0\n王城推出装备实名制，要求上传人脸。老纸戴着面具提交，系统判定：“面具即本人。”于是大家纷纷戴上更夸张的面具。摄政王很生气，下令升级算法。算法升级后，开始把所有人识别成“旅途疲惫的冒险者”，实名制依然形同虚设。`,
      `【小故事】法阵工单循环\n工程师报修：核心不亮。回复模板：“请重启，若无效请贴日志。”工程师贴日志，日志提示：“请重启并贴日志。”循环三次后，工程师直接把法阵踢了一脚，法阵亮了。于是工单系统新增一条官方建议：物理治疗有时有效。`,
      `【小故事】导师的台词包\n导师 NPC 自称曾是主角，现役任务是“指路”。他只有三句台词：“前方有危险”“选择在你”“不要后悔”。有一次他想尝试新台词，结果被脚本系统回滚。导师叹气：当年当主角最自由，现在只能当弹窗。新人安慰他：至少你不会被删档。`,
      `【小故事】倒计时静音失败\n玩家嫌倒计时音效太吵，系统推出“静音版”，结果改成了更大的鼓点，理由是“加强紧迫感”。鼓点还附带震动效果，连旁边的 NPC 都被震醒。玩家集体反馈，系统回应：“感谢建议，下一版将在视觉上增加红色闪光。”没人再提静音了。`,
      `【小故事】维护与掉率\n塔灵宣布：本周维护，维护后掉率翻倍。玩家齐声反对：“那先别维护。”塔灵改口：“维护后掉率恢复原样。”玩家立刻同意维护，理由是：至少不会更低。维护完成后，掉率确实恢复原样，塔灵在 changelog 里写：“优化了大家的心理预期。”`,
      `【小故事】流程怪物\n公会推行“凡事走流程”，怪物冲进城门被前台拦下填《攻击申请表》，需写清动机、路线和预计伤亡。怪物队长愤怒填表，排队排到夜里，攻城时间被拖没了。公会满意地宣布：本季度防御绩效达成。怪物则成立了“流程简化小组”。`,
      `【小故事】隐私弹窗\n黑市数字化转型，第一步是弹出《隐私政策》。洛璃想点“不同意但继续用”，发现按钮灰了。她改用火攻，政策弹窗被烧掉，后台立刻生成新的弹窗：“火攻不在允许范围，请勾选‘同意’继续。”洛璃最终勾选了，但备注写：不同意，纯粹懒得折腾。`,
      `【小故事】仪式抢救会\n摄政王催进度：“仪式怎么又失败？”工程师答：“需求昨晚又改，缓存失效。”摄政王怒骂，工程师淡定打开监控：是王室自己凌晨提交的“紧急小改”，备注“今天一定要上线”。最终他们决定把需求写进石碑，石碑刻完，仪式日程延后两周。`,
      `【小故事】外包线接单\n系统新增“外包线”任务，奖励写得很模糊。新人接单后发现要去帮魔王修 Wi-Fi，报酬是一张“勇者免打卡券”。新人回城炫耀免打卡，结果发现券只能在魔王城内生效。魔王感叹：现在的服务业真专业，连对手都能外包。`,
      `【小故事】幸运补丁\n塔灵送玩家一个补丁，描述：“修复走不直线问题。”玩家装上后，角色自动向宝箱微微偏移，被大家称为“幸运补丁”。有人拆包发现，补丁其实是把行走路径加了一点随机噪声，偏偏噪声方向朝宝箱，塔灵在注释里写：“让生活多一点惊喜”。`,
      `【小故事】备份意识觉醒\n王城法师提醒：魔力耗尽前请保存进度。众人齐声：“有 Ctrl+S 吗？”法师沉默，递纸笔让大家写日记。后来有人真凭日记回忆操作，成功复刻了一次关键战斗，被称为“人肉备份”。法师在讲义上补充：请定期备份记忆，不要只靠自动保存。`,
      `【小故事】猎头与勇者\n摄政王找猎头招勇者，猎头专业地问：能否接受弹性工作、跨国出差、周末值班？勇者皱眉：我以为我负责打怪。猎头笑：打怪只是主职，副职是随叫随到。勇者转身走人，摄政王叹气：人才市场也卷。`,
      `【小故事】广告免不了\n玩家问系统：能否开免广告？系统回答：升级到至尊会员。玩家追问：那广告没了？系统沉默三秒，答：广告会变成动态 4K，还送环绕音效。玩家心寒，决定关掉声音。系统提示：关闭声音将影响沉浸体验。玩家：我选择无声沉浸。`,
      `【小故事】排队副本\n热门副本限流，门口挂牌：“预计排队 30 分钟。”玩家想预约号，守卫说功能开发中。有人提出二级市场倒号，被公会查封。最终官方推出“排队同时挂机打卡送 1 金/分钟”，瞬间队伍秩序井然，因为大家都在挣钱。`
    ];

    function startJokeRotation() {
      if (jokeInterval) clearInterval(jokeInterval);
      jokeIndex = Math.floor(Math.random() * jokes.length);
      loadingJokeEl.textContent = jokes[jokeIndex];
      jokeInterval = setInterval(() => {
        jokeIndex = (jokeIndex + 1) % jokes.length;
        loadingJokeEl.textContent = jokes[jokeIndex];
      }, 10000);
    }

    function stopJokeRotation() {
      if (jokeInterval) {
        clearInterval(jokeInterval);
        jokeInterval = null;
      }
    }

    function renderWorkTags() {
      workTags.innerHTML = "";
      workList.forEach(name => {
        const tag = document.createElement("button");
        tag.textContent = name;
        tag.className = "btn-secondary";
        tag.style.padding = "8px 10px";
        tag.style.fontSize = "13px";
        tag.onclick = () => novelNameEl.value = name;
        workTags.appendChild(tag);
      });
    }
    renderWorkTags();

    addWorkBtn.onclick = () => {
      const name = newWorkEl.value.trim();
      if (!name) return;
      workList.unshift(name);
      renderWorkTags();
      novelNameEl.value = name;
      newWorkEl.value = "";
    };

    clearBtn.onclick = () => {
      outputEl.textContent = "";
      statusEl.textContent = "已清空，等待生成…";
    };

    copyBtn.onclick = () => {
      if (!outputEl.textContent) return;
      navigator.clipboard.writeText(outputEl.textContent).then(() => {
        downloadStatus.textContent = "已复制到剪贴板";
        setTimeout(() => downloadStatus.textContent = "准备就绪", 1500);
      });
    };

    downloadBtn.onclick = () => {
      if (!outputEl.textContent) return;
      const name = novelNameEl.value.trim() || "novel";
      const suffixMap = { outline: "00-大纲", characters: "01-人物档案", chapter: "章节预览" };
      const suffix = suffixMap[purposeEl.value] || "output";
      const blob = new Blob([outputEl.textContent], { type: "text/markdown;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${name}-${suffix}.md`;
      a.click();
      URL.revokeObjectURL(url);
      downloadStatus.textContent = `已下载：${name}-${suffix}.md`;
    };

    // 输入时移除错误样式
    [apiUrlEl, apiKeyEl, modelIdEl, novelNameEl].forEach(el => {
      el.addEventListener("input", () => el.classList.remove("input-error"));
    });

    generateBtn.onclick = async () => {
      const apiUrl = apiUrlEl.value.trim();
      const apiKey = apiKeyEl.value.trim();
      const modelId = modelIdEl.value.trim();
      const novel = novelNameEl.value.trim();
      // 清理错误样式
      [apiUrlEl, apiKeyEl, modelIdEl, novelNameEl].forEach(el => el.classList.remove("input-error"));
      let invalid = false;
      if (!apiUrl) { apiUrlEl.classList.add("input-error"); invalid = true; }
      if (!apiKey) { apiKeyEl.classList.add("input-error"); invalid = true; }
      if (!modelId) { modelIdEl.classList.add("input-error"); invalid = true; }
      if (!novel) { novelNameEl.classList.add("input-error"); invalid = true; }
      if (invalid) {
        statusEl.textContent = "请先填完红框字段：API 域名 / 模型 ID / API Key / 作品名。";
        return;
      }
      const payloadSummary = {
        作品: novel,
        类型: purposeEl.options[purposeEl.selectedIndex].text,
        题材: genreEl.value,
        主角设定: protagonistEl.value,
        主角性格: personalityEl.value,
        章节数: chaptersEl.value,
        基调: toneEl.value,
        反派设定: villainsEl.value || "未提供",
        额外: extraEl.value || "无"
      };

      const prompt = `你是中文长篇小说的策划与写作助手。根据用户参数生成对应内容，输出 Markdown。\n` +
        `用户参数：${JSON.stringify(payloadSummary, null, 2)}\n` +
        `要求：\n` +
        `- 生成类型 = ${payloadSummary.类型}；\n` +
        `- 若为大纲：提供章节表（${payloadSummary.章节数}章）、每章一句核心事件、悬念钩子；\n` +
        `- 若为人物档案：主角、反派、配角各至少1人，含性格/动机/缺陷/背景；\n` +
        `- 若为章节预览：给出第1章的开头场景、冲突、结尾钩子，建议字数 3000-5000；\n` +
        `- 输出只保留 Markdown 正文（不要代码块标签）。`;

      statusEl.textContent = "生成中...";
      generateBtn.disabled = true;
      generateBtn.textContent = "生成中...";
      loadingOverlay.style.display = "flex";
      startJokeRotation();
      currentAbortController = new AbortController();

      try {
        const resp = await fetch(apiUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: modelId,
            messages: [
              { role: "system", content: "你是严谨的小说写作助手，输出 Markdown，不加代码围栏。" },
              { role: "user", content: prompt }
            ],
            temperature: 0.7,
            stream: false
          }),
          signal: currentAbortController.signal
        });

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(`API 请求失败：${resp.status} ${text}`);
        }
        const data = await resp.json();
        const content = data.choices?.[0]?.message?.content || "（无内容返回）";
        outputEl.textContent = content;
        statusEl.textContent = "生成完成";
      } catch (err) {
        console.error(err);
        if (err.name === "AbortError") {
          statusEl.textContent = "已取消请求";
          outputEl.textContent = "";
        } else {
          statusEl.textContent = `错误：${err.message}`;
        }
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = "一键生成";
        loadingOverlay.style.display = "none";
        stopJokeRotation();
        currentAbortController = null;
      }
    };

    cancelBtn.onclick = () => {
      if (currentAbortController) {
        currentAbortController.abort();
      }
      stopJokeRotation();
    };
  </script>
</body>
</html>
